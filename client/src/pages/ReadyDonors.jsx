import React, { useEffect, useMemo, useState } from 'react';
import { Container, Row, Col, Card, Form, Button, Badge, Spinner, Tabs, Tab } from 'react-bootstrap';
import { useLocation, useNavigate } from 'react-router-dom';
import fetchWithInterceptors from '../services/fetchWithInterceptors';

const PAGE_SIZE = 12;
const isEight = (v='') => /^\d{8}$/.test(v);

// Helpers
const useQuery = () => new URLSearchParams(useLocation().search);

function BloodTab() {
  const locationHook = useLocation();
  const navigate = useNavigate();
  const params = useMemo(() => new URLSearchParams(locationHook.search), [locationHook.search]);

  const [filters, setFilters] = useState({
    location: params.get('location') || '',
    bloodType: params.get('bloodType') || ''
  });
  const [loading, setLoading] = useState(false);
  const [list, setList] = useState([]);
  const [page, setPage] = useState(1);

  const bloodTypes = ['','A+','A-','B+','B-','AB+','AB-','O+','O-','ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'];

  const fetchData = async () => {
    setLoading(true);
    try {
      const qs = new URLSearchParams();
      if (filters.location) qs.set('location', filters.location);
      if (filters.bloodType) qs.set('bloodType', filters.bloodType);
      const res = await fetchWithInterceptors(`/api/ready-to-donate-blood?${qs.toString()}`);
      const json = await res.json();
      setList(Array.isArray(json?.data) ? json.data : []);
    } catch (e) {
      console.error(e);
      setList([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchData(); /* eslint-disable-next-line */ }, []);

  const applyFilters = (ev) => {
    ev?.preventDefault?.();
    // Ø­Ø¯Ù‘Ø« URL
    const qs = new URLSearchParams();
    if (filters.bloodType) qs.set('bloodType', filters.bloodType);
    if (filters.location) qs.set('location', filters.location);
    navigate({ pathname: '/ready-donors', search: `?tab=blood&${qs.toString()}` });
    setPage(1);
    fetchData();
  };

  const paginated = useMemo(() => {
    const start = (page - 1) * PAGE_SIZE;
    return list.slice(start, start + PAGE_SIZE);
  }, [list, page]);

  return (
    <div dir="rtl">
      <Card className="border-0 shadow-sm mb-3">
        <Card.Body>
          <Form onSubmit={applyFilters} className="row g-3">
            <div className="col-md-4">
              <Form.Label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</Form.Label>
              <Form.Control
                placeholder="Ù…Ø«Ø§Ù„: Ù†ÙˆØ§ÙƒØ´ÙˆØ·"
                value={filters.location}
                onChange={(e)=>setFilters(f=>({...f, location: e.target.value}))}
              />
            </div>
            <div className="col-md-4">
              <Form.Label>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</Form.Label>
              <Form.Select
                value={filters.bloodType}
                onChange={(e)=>setFilters(f=>({...f, bloodType: e.target.value}))}
              >
                {bloodTypes.map(t => <option key={t || 'any'} value={t}>{t || 'Ø§Ù„ÙƒÙ„'}</option>)}
              </Form.Select>
            </div>
            <div className="col-md-4 d-flex align-items-end">
              <Button type="submit" className="me-auto">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</Button>
            </div>
          </Form>
        </Card.Body>
      </Card>

      {loading ? (
        <div className="text-center py-5"><Spinner /></div>
      ) : (
        <>
          <Row xs={1} md={2} lg={3} className="g-3">
            {paginated.map(item => (
              <Col key={item._id}>
                <Card className="h-100 border-0 shadow-sm">
                  <Card.Body>
                    <div className="d-flex justify-content-between align-items-start mb-2">
                      <h5 className="mb-0">Ù…ØªØ¨Ø±Ù‘Ø¹ Ø¨Ø§Ù„Ø¯Ù…</h5>
                      <Badge bg="danger">{item.bloodType}</Badge>
                    </div>
                    <div className="small text-muted mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹: {item.location || '-'}</div>
                    {item.note && <p className="mb-2">{item.note}</p>}

                    <div className="mt-3">
                      <div className="fw-bold mb-1">ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„:</div>
                      {(item.contactMethods || []).map((c, idx) => (
                        <div key={idx} className="small">
                          {c.method === 'phone' ? 'ğŸ“' : 'ğŸ’¬'} {c.number}
                        </div>
                      ))}
                    </div>
                  </Card.Body>
                  <Card.Footer className="small text-muted">
                    Ø£Ø¶ÙŠÙØª ÙÙŠ: {new Date(item.createdAt).toLocaleString('fr-FR')}
                  </Card.Footer>
                </Card>
              </Col>
            ))}
          </Row>

          {/* Pagination Ø¨Ø³ÙŠØ· */}
          {list.length > PAGE_SIZE && (
            <div className="d-flex justify-content-center gap-2 mt-3">
              <Button variant="outline-secondary" disabled={page===1} onClick={()=>setPage(p=>p-1)}>Ø§Ù„Ø³Ø§Ø¨Ù‚</Button>
              <div className="px-2 pt-2 small">ØµÙØ­Ø© {page} Ù…Ù† {Math.ceil(list.length/PAGE_SIZE)}</div>
              <Button variant="outline-secondary" disabled={page===Math.ceil(list.length/PAGE_SIZE)} onClick={()=>setPage(p=>p+1)}>Ø§Ù„ØªØ§Ù„ÙŠ</Button>
            </div>
          )}
        </>
      )}
    </div>
  );
}

function GeneralTab() {
  const locationHook = useLocation();
  const navigate = useNavigate();
  const params = useMemo(() => new URLSearchParams(locationHook.search), [locationHook.search]);

  const [filters, setFilters] = useState({
    city: params.get('city') || '',
    category: params.get('category') || ''
  });
  const [loading, setLoading] = useState(false);
  const [list, setList] = useState([]);
  const [page, setPage] = useState(1);

  const categories = ['', 'money', 'goods', 'time', 'other'];

  const fetchData = async () => {
    setLoading(true);
    try {
      const qs = new URLSearchParams();
      if (filters.city) qs.set('city', filters.city);
      if (filters.category) qs.set('category', filters.category);
      const res = await fetchWithInterceptors(`/api/ready-to-donate-general?${qs.toString()}`);
      const json = await res.json();
      setList(Array.isArray(json?.data) ? json.data : []);
    } catch (e) {
      console.error(e);
      setList([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchData(); /* eslint-disable-next-line */ }, []);

  const applyFilters = (ev) => {
    ev?.preventDefault?.();
    const qs = new URLSearchParams();
    if (filters.category) qs.set('category', filters.category);
    if (filters.city) qs.set('city', filters.city);
    navigate({ pathname: '/ready-donors', search: `?tab=general&${qs.toString()}` });
    setPage(1);
    fetchData();
  };

  const paginated = useMemo(() => {
    const start = (page - 1) * PAGE_SIZE;
    return list.slice(start, start + PAGE_SIZE);
  }, [list, page]);

  const labelMap = { money: 'Ù…Ø§Ù„ÙŠ', goods: 'Ù…ÙˆØ§Ø¯', time: 'ÙˆÙ‚Øª/Ø¬Ù‡Ø¯', other: 'Ø£Ø®Ø±Ù‰' };

  return (
    <div dir="rtl">
      <Card className="border-0 shadow-sm mb-3">
        <Card.Body>
          <Form onSubmit={applyFilters} className="row g-3">
            <div className="col-md-4">
              <Form.Label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</Form.Label>
              <Form.Control
                placeholder="Ù…Ø«Ø§Ù„: Ù†ÙˆØ§ÙƒØ´ÙˆØ·"
                value={filters.city}
                onChange={(e)=>setFilters(f=>({...f, city: e.target.value}))}
              />
            </div>
            <div className="col-md-4">
              <Form.Label>Ù†ÙˆØ¹ Ø§Ù„ØªØ¨Ø±Ø¹</Form.Label>
              <Form.Select
                value={filters.category}
                onChange={(e)=>setFilters(f=>({...f, category: e.target.value}))}
              >
                {categories.map(c => <option key={c || 'any'} value={c}>{c ? labelMap[c] : 'Ø§Ù„ÙƒÙ„'}</option>)}
              </Form.Select>
            </div>
            <div className="col-md-4 d-flex align-items-end">
              <Button type="submit" className="me-auto">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</Button>
            </div>
          </Form>
        </Card.Body>
      </Card>

      {loading ? (
        <div className="text-center py-5"><Spinner /></div>
      ) : (
        <>
          <Row xs={1} md={2} lg={3} className="g-3">
            {paginated.map(item => (
              <Col key={item._id}>
                <Card className="h-100 border-0 shadow-sm">
                  <Card.Body>
                    <div className="d-flex justify-content-between align-items-start mb-2">
                      <h5 className="mb-0">Ù…ØªØ¨Ø±Ù‘Ø¹ Ø¹Ø§Ù…</h5>
                      <Badge bg="primary">{labelMap[item?.extra?.category] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</Badge>
                    </div>
                    <div className="small text-muted mb-2">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: {item.city || '-'}</div>
                    {item.note && <p className="mb-2">{item.note}</p>}

                    <div className="mt-3">
                      <div className="fw-bold mb-1">ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„:</div>
                      {(item.contactMethods || []).map((c, idx) => (
                        <div key={idx} className="small">
                          {c.method === 'phone' ? 'ğŸ“' : 'ğŸ’¬'} {c.number}
                        </div>
                      ))}
                    </div>
                  </Card.Body>
                  <Card.Footer className="small text-muted">
                    Ø£Ø¶ÙŠÙØª ÙÙŠ: {new Date(item.createdAt).toLocaleString('fr-FR')}
                  </Card.Footer>
                </Card>
              </Col>
            ))}
          </Row>

          {list.length > PAGE_SIZE && (
            <div className="d-flex justify-content-center gap-2 mt-3">
              <Button variant="outline-secondary" disabled={page===1} onClick={()=>setPage(p=>p-1)}>Ø§Ù„Ø³Ø§Ø¨Ù‚</Button>
              <div className="px-2 pt-2 small">ØµÙØ­Ø© {page} Ù…Ù† {Math.ceil(list.length/PAGE_SIZE)}</div>
              <Button variant="outline-secondary" disabled={page===Math.ceil(list.length/PAGE_SIZE)} onClick={()=>setPage(p=>p+1)}>Ø§Ù„ØªØ§Ù„ÙŠ</Button>
            </div>
          )}
        </>
      )}
    </div>
  );
}

export default function ReadyDonors() {
  const q = useQuery();
  const defaultKey = q.get('tab') === 'general' ? 'general' : 'blood';

  return (
    <Container className="py-4" dir="rtl">
      <div className="mb-3">
        <h2 className="fw-bold">Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ù…Ø³ØªØ¹Ø¯ÙŠÙ† Ù„Ù„ØªØ¨Ø±Ø¹Ø§Øª</h2>
        <div className="text-muted">Ø§Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹Ù‹Ø§ Ø¹Ù† Ù…ØªØ¨Ø±Ø¹ÙŠÙ† Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù„Ù„ØªÙˆØ§ØµÙ„.</div>
      </div>

      <Tabs defaultActiveKey={defaultKey} activeKey={defaultKey} id="ready-tabs" className="mb-3"
        onSelect={(k)=> {
          const base = '/ready-donors';
          const s = new URLSearchParams(window.location.search);
          s.set('tab', k);
          window.history.replaceState(null, '', `${base}?${s.toString()}`);
        }}
      >
        <Tab eventKey="blood" title="Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø¯Ù…">
          <BloodTab />
        </Tab>
        <Tab eventKey="general" title="Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©">
          <GeneralTab />
        </Tab>
      </Tabs>
    </Container>
  );
}
